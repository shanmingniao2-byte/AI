<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Prompt Enhancer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  </head>
  <body>
    <div class="page">
      <header>
        <h1>AI Prompt Enhancer</h1>
        <p>优化提示词、扩写场景关键词，并提供多语言互译矩阵，助力图像创作</p>
      </header>
      <main>
        <section class="panel">
          <form id="prompt-form">
            <label for="prompt">输入原始提示词</label>
            <textarea id="prompt" name="prompt" rows="6" placeholder="例如：Cyberpunk portrait with neon lighting at sunset"></textarea>

            <label for="creativity">扩写创造力 <span id="creativity-value">0.5</span></label>
            <input type="range" id="creativity" name="creativity" min="0" max="1" step="0.1" value="0.5" />

            <fieldset>
              <legend>互译涉及语言</legend>
              {% for lang in languages %}
              <label class="checkbox">
                <input type="checkbox" name="languages" value="{{ lang.code }}" checked />
                <span>{{ lang.label }}</span>
              </label>
              {% endfor %}
            </fieldset>

            <div class="action-buttons">
              <button type="submit" id="generate-button">生成增强提示词</button>
              <button type="button" id="expand-button" class="secondary">
                提示词扩写
              </button>
              <button type="button" id="translate-button" class="secondary">
                多语言互译
              </button>
            </div>
          </form>
        </section>

        <section class="panel" id="result" hidden>
          <h2>分析结果</h2>
          <div class="result-block">
            <h3>检测语言</h3>
            <p id="detected-language"></p>
          </div>
          <div class="result-block">
            <h3>优化后的提示词</h3>
            <p id="optimized"></p>
          </div>
          <div class="result-block">
            <h3>关键词</h3>
            <ul id="keywords"></ul>
          </div>
          <div class="result-block">
            <h3>提示词扩写（场景关键词）</h3>
            <p id="expanded"></p>
          </div>
          <div class="result-block">
            <h3>多语言互译</h3>
            <div id="translations"></div>
          </div>
          <div class="result-block" id="suggestions" hidden>
            <h3>推荐修饰词</h3>
          </div>
        </section>
      </main>
    </div>

    <script>
      const form = document.getElementById("prompt-form");
      const resultPanel = document.getElementById("result");
      const detectedLanguageEl = document.getElementById("detected-language");
      const optimizedEl = document.getElementById("optimized");
      const keywordsEl = document.getElementById("keywords");
      const expandedEl = document.getElementById("expanded");
      const translationsEl = document.getElementById("translations");
      const suggestionsEl = document.getElementById("suggestions");
      const expandButton = document.getElementById("expand-button");
      const translateButton = document.getElementById("translate-button");
      const creativityInput = document.getElementById("creativity");
      const creativityValue = document.getElementById("creativity-value");

      creativityInput.addEventListener("input", () => {
        creativityValue.textContent = creativityInput.value;
      });

      expandButton.addEventListener("click", async () => {
        const payload = collectFormValues();
        const response = await fetch("/api/expand", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        ensureResultPanel();
        updateCoreSections(data);
        updateTranslations({});
      });

      translateButton.addEventListener("click", async () => {
        const payload = collectFormValues();
        const response = await fetch("/api/translate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        ensureResultPanel();
        updateCoreSections(data);
        updateTranslations(data.translations || {});
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const payload = collectFormValues();
        const response = await fetch("/api/process", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        renderResult(data);
      });

      function collectFormValues() {
        const formData = new FormData(form);
        const prompt = formData.get("prompt");
        const creativity = formData.get("creativity");
        const languages = formData.getAll("languages");
        return { prompt, creativity, languages };
      }

      function renderResult(data) {
        ensureResultPanel();
        updateCoreSections(data);
        updateTranslations(data.translations || {});
      }

      function ensureResultPanel() {
        resultPanel.hidden = false;
      }

      function updateCoreSections(data) {
        const detectedCode = data.detected_language_code
          ? data.detected_language_code.toUpperCase()
          : "";
        detectedLanguageEl.textContent = detectedCode
          ? `${data.detected_language} (${detectedCode})`
          : data.detected_language || "-";
        optimizedEl.textContent = data.optimized_prompt || "-";
        keywordsEl.innerHTML = "";
        (data.keywords || []).forEach((word) => {
          const li = document.createElement("li");
          li.textContent = word;
          keywordsEl.appendChild(li);
        });
        expandedEl.textContent = data.expanded_prompt || "-";

        const suggestions = data.suggestions || {};
        suggestionsEl.innerHTML = "";
        if (Object.keys(suggestions).length) {
          suggestionsEl.hidden = false;
          Object.entries(suggestions).forEach(([category, options]) => {
            const block = document.createElement("div");
            block.className = "suggestion-category";
            block.innerHTML = `<h4>${category}</h4>`;
            const list = document.createElement("ul");
            options.forEach((item) => {
              const li = document.createElement("li");
              li.textContent = item;
              list.appendChild(li);
            });
            block.appendChild(list);
            suggestionsEl.appendChild(block);
          });
        } else {
          suggestionsEl.hidden = true;
        }
      }

      function updateTranslations(translationEntries) {
        translationsEl.innerHTML = "";
        if (!Object.keys(translationEntries).length) {
          const empty = document.createElement("p");
          empty.className = "empty-hint";
          empty.textContent = "请选择至少一种语言以查看互译结果。";
          translationsEl.appendChild(empty);
          return;
        }

        Object.entries(translationEntries).forEach(([code, entry]) => {
          const block = document.createElement("div");
          block.className = "translation-matrix";

          const heading = document.createElement("div");
          heading.className = "translation-heading";
          heading.innerHTML = `<strong>${entry.label}</strong> <span class="tag">${code.toUpperCase()}</span>`;
          block.appendChild(heading);

          const base = document.createElement("p");
          base.className = "translation-base";
          base.textContent = entry.base_text || "-";
          block.appendChild(base);

          const mutual = entry.mutual || {};
          if (Object.keys(mutual).length) {
            const list = document.createElement("ul");
            list.className = "translation-targets";
            Object.entries(mutual).forEach(([targetCode, text]) => {
              const li = document.createElement("li");
              li.innerHTML = `<span class="tag">${targetCode.toUpperCase()}</span> ${text || "-"}`;
              list.appendChild(li);
            });
            block.appendChild(list);
          }

          translationsEl.appendChild(block);
        });
      }
    </script>
  </body>
</html>
